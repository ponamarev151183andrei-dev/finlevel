<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero's Quest ‚Äî RPG</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        
        body {
            background: #0a0f1e;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Arial', sans-serif;
            padding: 10px;
        }
        
        #gameContainer {
            background: #1a1f2e;
            border-radius: 30px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 800px;
            width: 100%;
        }
        
        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 20px;
            background: #2a2f3e;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
            width: 100%;
            height: auto;
            aspect-ratio: 1/1;
            cursor: crosshair;
            touch-action: none;
        }
        
        .stats-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 15px;
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            color: #a0b0d0;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: white;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .control-btn {
            background: #2a3a5a;
            border: none;
            border-radius: 15px;
            padding: 15px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #1a2a40;
            transition: all 0.1s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .control-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        
        .attack-btn {
            background: #c44;
            box-shadow: 0 4px 0 #a22;
            grid-column: span 2;
        }
        
        .restart-btn {
            background: #44a;
            box-shadow: 0 4px 0 #228;
            grid-column: span 2;
        }
        
        .inventory-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .inventory-title {
            color: #a0b0d0;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .inventory-slot {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .log-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 10px;
            margin-top: 15px;
            height: 80px;
            overflow-y: auto;
            font-size: 14px;
            color: #a0b0d0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .log-entry {
            padding: 4px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .skill-btn {
            background: #5a4a8a;
            border: none;
            border-radius: 10px;
            padding: 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            margin: 2px;
        }
        
        @keyframes damageFlash {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
            100% { filter: brightness(1); }
        }
        
        .damage-effect {
            animation: damageFlash 0.2s;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="600" height="600"></canvas>
        
        <div class="stats-panel">
            <div class="stat">
                <div class="stat-label">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</div>
                <div class="stat-value" id="healthDisplay">100/100</div>
            </div>
            <div class="stat">
                <div class="stat-label">üìä –£—Ä–æ–≤–µ–Ω—å</div>
                <div class="stat-value" id="levelDisplay">1</div>
            </div>
            <div class="stat">
                <div class="stat-label">‚ö° –û–ø—ã—Ç</div>
                <div class="stat-value" id="expDisplay">0/100</div>
            </div>
            <div class="stat">
                <div class="stat-label">üí∞ –ó–æ–ª–æ—Ç–æ</div>
                <div class="stat-value" id="goldDisplay">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">‚öîÔ∏è –°–∏–ª–∞</div>
                <div class="stat-value" id="powerDisplay">10</div>
            </div>
            <div class="stat">
                <div class="stat-label">üõ°Ô∏è –ó–∞—â–∏—Ç–∞</div>
                <div class="stat-value" id="defenseDisplay">5</div>
            </div>
        </div>
        
        <div class="inventory-panel">
            <div class="inventory-title">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
            <div class="inventory-grid" id="inventoryGrid">
                <div class="inventory-slot">‚öîÔ∏è</div>
                <div class="inventory-slot">üõ°Ô∏è</div>
                <div class="inventory-slot">üß™</div>
                <div class="inventory-slot">üìø</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="control-btn" id="upBtn">‚Üë</button>
            <button class="control-btn" id="downBtn">‚Üì</button>
            <button class="control-btn" id="leftBtn">‚Üê</button>
            <button class="control-btn" id="rightBtn">‚Üí</button>
            <button class="control-btn attack-btn" id="attackBtn">‚öîÔ∏è –ê—Ç–∞–∫–∞</button>
            <button class="control-btn" id="skillBtn">‚ú® –£–º–µ–Ω–∏–µ</button>
            <button class="control-btn restart-btn" id="restartBtn">üîÑ –ó–∞–Ω–æ–≤–æ</button>
        </div>
        
        <div class="log-panel" id="logPanel">
            <div class="log-entry">‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Hero's Quest!</div>
            <div class="log-entry">‚öîÔ∏è –£–±–µ–π –≤—Å–µ—Ö –≤—Ä–∞–≥–æ–≤, —á—Ç–æ–±—ã –ø–æ–±–µ–¥–∏—Ç—å</div>
            <div class="log-entry">üí° –ò—Å–ø–æ–ª—å–∑—É–π —É–º–µ–Ω–∏–µ –¥–ª—è –º–æ—â–Ω–æ–π –∞—Ç–∞–∫–∏</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // ==================== –ò–ì–†–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let gameRunning = true;
        let keys = {};
        let lastTime = 0;
        let logMessages = [];
        let skillCooldown = 0;
        let skillCooldownMax = 300; // 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ 60fps
        
        // ==================== –ò–ì–†–û–ö ====================
        let player = {
            x: 300,
            y: 300,
            width: 30,
            height: 30,
            speed: 3,
            health: 100,
            maxHealth: 100,
            level: 1,
            exp: 0,
            expToNext: 100,
            gold: 0,
            power: 10,
            defense: 5,
            attackCooldown: 0,
            attackCooldownMax: 20,
            invincible: 0,
            inventory: ['sword', 'shield', 'potion', 'amulet']
        };
        
        // ==================== –í–†–ê–ì–ò ====================
        let enemies = [
            { x: 100, y: 100, width: 25, height: 25, health: 40, maxHealth: 40, power: 5, defense: 2, speed: 1, type: 'goblin', value: 20, expValue: 15 },
            { x: 500, y: 150, width: 25, height: 25, health: 40, maxHealth: 40, power: 5, defense: 2, speed: 1.2, type: 'goblin', value: 20, expValue: 15 },
            { x: 200, y: 500, width: 25, height: 25, health: 40, maxHealth: 40, power: 5, defense: 2, speed: 0.8, type: 'goblin', value: 20, expValue: 15 },
            { x: 450, y: 450, width: 40, height: 40, health: 80, maxHealth: 80, power: 12, defense: 5, speed: 0.4, type: 'ogre', value: 50, expValue: 40 },
            { x: 300, y: 100, width: 20, height: 20, health: 25, maxHealth: 25, power: 8, defense: 1, speed: 1.5, type: 'imp', value: 15, expValue: 10 }
        ];
        
        // ==================== –ü–†–ï–î–ú–ï–¢–´ ====================
        let items = [
            { x: 400, y: 200, width: 15, height: 15, type: 'gold', value: 10 },
            { x: 150, y: 400, width: 15, height: 15, type: 'gold', value: 10 },
            { x: 350, y: 350, width: 20, height: 20, type: 'potion', value: 30 },
            { x: 250, y: 250, width: 20, height: 20, type: 'healthPotion', value: 50 },
            { x: 500, y: 500, width: 20, height: 20, type: 'sword', value: 5 }
        ];
        
        // ==================== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ====================
        function addLog(message) {
            logMessages.unshift(message);
            if (logMessages.length > 5) logMessages.pop();
            updateLogPanel();
        }
        
        function updateLogPanel() {
            const panel = document.getElementById('logPanel');
            panel.innerHTML = logMessages.map(msg => `<div class="log-entry">${msg}</div>`).join('');
        }
        
        // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò ====================
        function updateStats() {
            document.getElementById('healthDisplay').textContent = `${player.health}/${player.maxHealth}`;
            document.getElementById('levelDisplay').textContent = player.level;
            document.getElementById('expDisplay').textContent = `${player.exp}/${player.expToNext}`;
            document.getElementById('goldDisplay').textContent = player.gold;
            document.getElementById('powerDisplay').textContent = player.power;
            document.getElementById('defenseDisplay').textContent = player.defense;
        }
        
        // ==================== –ò–ù–í–ï–ù–¢–ê–†–¨ ====================
        function updateInventory() {
            const grid = document.getElementById('inventoryGrid');
            let icons = {
                'sword': '‚öîÔ∏è',
                'shield': 'üõ°Ô∏è',
                'potion': 'üß™',
                'amulet': 'üìø',
                'healthPotion': 'üíä'
            };
            grid.innerHTML = player.inventory.map(item => 
                `<div class="inventory-slot">${icons[item] || 'üì¶'}</div>`
            ).join('');
        }
        
        // ==================== –î–í–ò–ñ–ï–ù–ò–ï –ò–ì–†–û–ö–ê ====================
        function movePlayer() {
            if (!gameRunning) return;
            
            let dx = 0, dy = 0;
            
            if (keys['w'] || keys['W'] || keys['ArrowUp']) dy -= 1;
            if (keys['s'] || keys['S'] || keys['ArrowDown']) dy += 1;
            if (keys['a'] || keys['A'] || keys['ArrowLeft']) dx -= 1;
            if (keys['d'] || keys['D'] || keys['ArrowRight']) dx += 1;
            
            if (dx !== 0 || dy !== 0) {
                let length = Math.sqrt(dx*dx + dy*dy);
                dx = dx / length * player.speed;
                dy = dy / length * player.speed;
                
                let newX = player.x + dx;
                let newY = player.y + dy;
                
                // –ì—Ä–∞–Ω–∏—Ü—ã
                player.x = Math.max(20, Math.min(580, newX));
                player.y = Math.max(20, Math.min(580, newY));
            }
        }
        
        // ==================== –ê–¢–ê–ö–ê ====================
        function attack() {
            if (!gameRunning || player.attackCooldown > 0) return;
            
            player.attackCooldown = player.attackCooldownMax;
            
            let attackRange = 60;
            let attackDamage = player.power;
            
            for (let i = enemies.length - 1; i >= 0; i--) {
                let enemy = enemies[i];
                let dx = enemy.x - player.x;
                let dy = enemy.y - player.y;
                let distance = Math.sqrt(dx*dx + dy*dy);
                
                if (distance < attackRange) {
                    let damage = Math.max(1, attackDamage - enemy.defense);
                    enemy.health -= damage;
                    addLog(`‚öîÔ∏è –ê—Ç–∞–∫–∞! ${damage} —É—Ä–æ–Ω–∞ –≥–æ–±–ª–∏–Ω—É`);
                    
                    if (enemy.health <= 0) {
                        player.gold += enemy.value;
                        player.exp += enemy.expValue;
                        enemies.splice(i, 1);
                        addLog(`üíÄ –£–±–∏—Ç –≤—Ä–∞–≥! +${enemy.value}üí∞ +${enemy.expValue}‚ú®`);
                        
                        // –ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
                        if (player.exp >= player.expToNext) {
                            player.level++;
                            player.exp -= player.expToNext;
                            player.expToNext = Math.floor(player.expToNext * 1.5);
                            player.maxHealth += 20;
                            player.health = player.maxHealth;
                            player.power += 5;
                            player.defense += 2;
                            addLog(`‚ú® –£–†–û–í–ï–ù–¨ ${player.level}! –°–∏–ª–∞+5 –ó–∞—â–∏—Ç–∞+2`);
                        }
                    }
                }
            }
        }
        
        // ==================== –£–ú–ï–ù–ò–ï ====================
        function useSkill() {
            if (!gameRunning || skillCooldown > 0) return;
            
            skillCooldown = skillCooldownMax;
            addLog(`‚ú® –ú–û–©–ù–û–ï –£–ú–ï–ù–ò–ï! –£—Ä–æ–Ω x2`);
            
            for (let i = enemies.length - 1; i >= 0; i--) {
                let enemy = enemies[i];
                let dx = enemy.x - player.x;
                let dy = enemy.y - player.y;
                let distance = Math.sqrt(dx*dx + dy*dy);
                
                if (distance < 100) {
                    let damage = player.power * 3;
                    enemy.health -= damage;
                    addLog(`üí• –ö–†–ò–¢! ${damage} —É—Ä–æ–Ω–∞`);
                    
                    if (enemy.health <= 0) {
                        player.gold += enemy.value * 2;
                        player.exp += enemy.expValue * 2;
                        enemies.splice(i, 1);
                    }
                }
            }
        }
        
        // ==================== –î–í–ò–ñ–ï–ù–ò–ï –í–†–ê–ì–û–í ====================
        function moveEnemies() {
            for (let enemy of enemies) {
                let dx = player.x - enemy.x;
                let dy = player.y - enemy.y;
                let distance = Math.sqrt(dx*dx + dy*dy);
                
                if (distance > 0) {
                    dx = dx / distance * enemy.speed;
                    dy = dy / distance * enemy.speed;
                    
                    enemy.x += dx;
                    enemy.y += dy;
                    
                    enemy.x = Math.max(15, Math.min(585, enemy.x));
                    enemy.y = Math.max(15, Math.min(585, enemy.y));
                }
            }
        }
        
        // ==================== –ö–û–õ–õ–ò–ó–ò–ò ====================
        function checkCollisions() {
            if (!gameRunning || player.invincible > 0) {
                player.invincible--;
                return;
            }
            
            for (let enemy of enemies) {
                let dx = player.x - enemy.x;
                let dy = player.y - enemy.y;
                let distance = Math.sqrt(dx*dx + dy*dy);
                
                if (distance < (player.width/2 + enemy.width/2)) {
                    let damage = Math.max(1, enemy.power - player.defense/2);
                    player.health -= damage;
                    player.invincible = 30;
                    canvas.classList.add('damage-effect');
                    setTimeout(() => canvas.classList.remove('damage-effect'), 200);
                    addLog(`üíî –ü–æ–ª—É—á–µ–Ω —É—Ä–æ–Ω: ${damage}`);
                    
                    if (player.health <= 0) {
                        gameRunning = false;
                        addLog('‚ùå –¢—ã –ø–æ–≥–∏–±... –ù–∞–∂–º–∏ "–ó–∞–Ω–æ–≤–æ"');
                    }
                }
            }
        }
        
        // ==================== –°–ë–û–† –ü–†–ï–î–ú–ï–¢–û–í ====================
        function collectItems() {
            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                let dx = player.x - item.x;
                let dy = player.y - item.y;
                let distance = Math.sqrt(dx*dx + dy*dy);
                
                if (distance < (player.width/2 + item.width/2)) {
                    if (item.type === 'gold') {
                        player.gold += item.value;
                        addLog(`üí∞ +${item.value} –∑–æ–ª–æ—Ç–∞`);
                    } else if (item.type === 'potion') {
                        player.power += item.value;
                        addLog(`‚öîÔ∏è –°–∏–ª–∞ +${item.value}`);
                    } else if (item.type === 'healthPotion') {
                        player.health = Math.min(player.maxHealth, player.health + item.value);
                        addLog(`‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ +${item.value}`);
                    } else {
                        player.inventory.push(item.type);
                        addLog(`üì¶ –ù–∞–π–¥–µ–Ω –ø—Ä–µ–¥–º–µ—Ç!`);
                        updateInventory();
                    }
                    items.splice(i, 1);
                }
            }
        }
        
        // ==================== –ü–†–û–í–ï–†–ö–ê –ü–û–ë–ï–î–´ ====================
        function checkVictory() {
            if (enemies.length === 0) {
                gameRunning = false;
                addLog('üèÜ –ü–û–ë–ï–î–ê! –í—Å–µ –≤—Ä–∞–≥–∏ –ø–æ–≤–µ—Ä–∂–µ–Ω—ã!');
                addLog(`üí∞ –ò—Ç–æ–≥–æ–≤–æ–µ –∑–æ–ª–æ—Ç–æ: ${player.gold}`);
                addLog(`üìä –î–æ—Å—Ç–∏–≥–Ω—É—Ç —É—Ä–æ–≤–µ–Ω—å: ${player.level}`);
            }
        }
        
        // ==================== –û–¢–†–ò–°–û–í–ö–ê ====================
        function draw() {
            ctx.clearRect(0, 0, 600, 600);
            
            // –°–µ—Ç–∫–∞
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 600; i += 50) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, 600);
                ctx.stroke();
                ctx.moveTo(0, i);
                ctx.lineTo(600, i);
                ctx.stroke();
            }
            
            // –ü—Ä–µ–¥–º–µ—Ç—ã
            for (let item of items) {
                ctx.shadowBlur = 20;
                if (item.type === 'gold') {
                    ctx.fillStyle = '#ffd700';
                    ctx.shadowColor = '#ffd700';
                } else if (item.type === 'potion') {
                    ctx.fillStyle = '#ff6b6b';
                    ctx.shadowColor = '#ff6b6b';
                } else if (item.type === 'healthPotion') {
                    ctx.fillStyle = '#ff4444';
                    ctx.shadowColor = '#ff4444';
                } else {
                    ctx.fillStyle = '#aa88ff';
                    ctx.shadowColor = '#aa88ff';
                }
                
                ctx.beginPath();
                ctx.arc(item.x, item.y, item.width/2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // –í—Ä–∞–≥–∏
            for (let enemy of enemies) {
                ctx.shadowBlur = 30;
                ctx.shadowColor = enemy.type === 'ogre' ? '#f44' : (enemy.type === 'imp' ? '#f90' : '#4a4');
                
                // –¢–µ–ª–æ
                if (enemy.type === 'goblin') {
                    ctx.fillStyle = '#4a4';
                } else if (enemy.type === 'ogre') {
                    ctx.fillStyle = '#c44';
                } else {
                    ctx.fillStyle = '#f90';
                }
                
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.width/2, 0, Math.PI * 2);
                ctx.fill();
                
                // –ì–ª–∞–∑–∞
                ctx.fillStyle = '#fff';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(enemy.x-5, enemy.y-5, 3, 0, Math.PI * 2);
                ctx.arc(enemy.x+5, enemy.y-5, 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(enemy.x-5, enemy.y-5, 1.5, 0, Math.PI * 2);
                ctx.arc(enemy.x+5, enemy.y-5, 1.5, 0, Math.PI * 2);
                ctx.fill();
                
                // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#000';
                ctx.fillRect(enemy.x-15, enemy.y-25, 30, 4);
                let healthPercent = enemy.health / enemy.maxHealth;
                ctx.fillStyle = healthPercent > 0.6 ? '#0f0' : (healthPercent > 0.3 ? '#ff0' : '#f00');
                ctx.fillRect(enemy.x-15, enemy.y-25, 30 * healthPercent, 4);
            }
            
            // –ò–≥—Ä–æ–∫
            ctx.shadowBlur = player.invincible > 0 ? 40 : 20;
            ctx.shadowColor = player.invincible > 0 ? '#ff0' : '#4af';
            
            ctx.fillStyle = '#4af';
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.width/2, 0, Math.PI * 2);
            ctx.fill();
            
            // –ì–ª–∞–∑–∞
            ctx.fillStyle = '#fff';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.arc(player.x-6, player.y-8, 4, 0, Math.PI * 2);
            ctx.arc(player.x+6, player.y-8, 4, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#00f';
            ctx.beginPath();
            ctx.arc(player.x-6 + (keys['d']?2:0) - (keys['a']?-2:0), 
                    player.y-8 + (keys['s']?2:0) - (keys['w']?-2:0), 2, 0, Math.PI * 2);
            ctx.arc(player.x+6 + (keys['d']?2:0) - (keys['a']?-2:0), 
                    player.y-8 + (keys['s']?2:0) - (keys['w']?-2:0), 2, 0, Math.PI * 2);
            ctx.fill();
            
            // –ú–µ—á –ø—Ä–∏ –∞—Ç–∞–∫–µ
            if (player.attackCooldown > 0) {
                ctx.shadowBlur = 30;
                ctx.shadowColor = '#ff0';
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(player.x, player.y);
                ctx.lineTo(player.x + 40, player.y - 20);
                ctx.stroke();
            }
            
            // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#000';
            ctx.fillRect(player.x-25, player.y-35, 50, 6);
            let healthPercent = player.health / player.maxHealth;
            ctx.fillStyle = healthPercent > 0.6 ? '#0f0' : (healthPercent > 0.3 ? '#ff0' : '#f00');
            ctx.fillRect(player.x-25, player.y-35, 50 * healthPercent, 6);
            
            // –ö—É–ª–¥–∞—É–Ω —É–º–µ–Ω–∏—è
            if (skillCooldown > 0) {
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.beginPath();
                ctx.arc(550, 50, 20, 0, (skillCooldown / skillCooldownMax) * Math.PI * 2);
                ctx.lineTo(550, 50);
                ctx.fill();
            }
        }
        
        // ==================== –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ====================
        function gameLoop() {
            if (gameRunning) {
                movePlayer();
                moveEnemies();
                checkCollisions();
                collectItems();
                checkVictory();
                player.attackCooldown = Math.max(0, player.attackCooldown - 1);
                skillCooldown = Math.max(0, skillCooldown - 1);
            }
            
            draw();
            updateStats();
            requestAnimationFrame(gameLoop);
        }
        
        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï ====================
        document.getElementById('upBtn').addEventListener('mousedown', () => keys['w'] = true);
        document.getElementById('upBtn').addEventListener('mouseup', () => keys['w'] = false);
        document.getElementById('upBtn').addEventListener('mouseleave', () => keys['w'] = false);
        
        document.getElementById('downBtn').addEventListener('mousedown', () => keys['s'] = true);
        document.getElementById('downBtn').addEventListener('mouseup', () => keys['s'] = false);
        document.getElementById('downBtn').addEventListener('mouseleave', () => keys['s'] = false);
        
        document.getElementById('leftBtn').addEventListener('mousedown', () => keys['a'] = true);
        document.getElementById('leftBtn').addEventListener('mouseup', () => keys['a'] = false);
        document.getElementById('leftBtn').addEventListener('mouseleave', () => keys['a'] = false);
        
        document.getElementById('rightBtn').addEventListener('mousedown', () => keys['d'] = true);
        document.getElementById('rightBtn').addEventListener('mouseup', () => keys['d'] = false);
        document.getElementById('rightBtn').addEventListener('mouseleave', () => keys['d'] = false);
        
        document.getElementById('attackBtn').addEventListener('click', attack);
        document.getElementById('skillBtn').addEventListener('click', useSkill);
        
        document.getElementById('restartBtn').addEventListener('click', () => {
            location.reload();
        });
        
        // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === ' ') {
                attack();
                e.preventDefault();
            }
            if (e.key === 'e' || e.key === 'E') {
                useSkill();
                e.preventDefault();
            }
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        
        // –°–µ–Ω—Å–æ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        let touchStartX, touchStartY;
        let touchThreshold = 30;
        
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            let touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
        });
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!touchStartX || !touchStartY) return;
            
            let touch = e.touches[0];
            let dx = touch.clientX - touchStartX;
            let dy = touch.clientY - touchStartY;
            
            keys['w'] = keys['a'] = keys['s'] = keys['d'] = false;
            
            if (Math.abs(dx) > touchThreshold) {
                keys[dx > 0 ? 'd' : 'a'] = true;
            }
            if (Math.abs(dy) > touchThreshold) {
                keys[dy > 0 ? 's' : 'w'] = true;
            }
        });
        
        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys['w'] = keys['a'] = keys['s'] = keys['d'] = false;
            touchStartX = touchStartY = null;
        });
        
        // –î–≤–æ–π–Ω–æ–π —Ç–∞–ø –¥–ª—è –∞—Ç–∞–∫–∏
        let lastTap = 0;
        canvas.addEventListener('touchend', (e) => {
            let currentTime = new Date().getTime();
            let tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                attack();
            }
            lastTap = currentTime;
        });
        
        // ==================== –°–¢–ê–†–¢ ====================
        updateInventory();
        gameLoop();
        updateStats();
        
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
    </script>
</body>
</html>
